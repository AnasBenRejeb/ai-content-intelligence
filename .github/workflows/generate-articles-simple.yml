name: Generate Articles (Simple Test)

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests rapidfuzz python-dotenv
    
    - name: Create directories
      run: |
        mkdir -p generated_articles
    
    - name: Generate simple test article
      env:
        NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
      run: |
        python << 'EOF'
        import requests
        import os
        from datetime import datetime
        from pathlib import Path
        
        print("ðŸš€ Fetching articles from NewsAPI...")
        
        api_key = os.environ.get('NEWSAPI_KEY')
        url = f"https://newsapi.org/v2/top-headlines?category=technology&pageSize=5&apiKey={api_key}"
        
        response = requests.get(url)
        data = response.json()
        
        if data.get('status') == 'ok' and data.get('articles'):
            articles = data['articles']
            print(f"âœ… Found {len(articles)} articles")
            
            for i, article in enumerate(articles[:3], 1):
                title = article.get('title', 'Untitled')
                description = article.get('description', 'No description')
                url = article.get('url', 'No URL')
                source = article.get('source', {}).get('name', 'Unknown')
                published = article.get('publishedAt', 'Unknown')
                
                # Create safe filename
                safe_title = "".join(c for c in title[:50] if c.isalnum() or c in (' ', '-', '_')).strip()
                filename = f"generated_articles/article_{i}_{safe_title}.md"
                
                content = f"""# {title}

**Source:** {source}  
**Published:** {published}  
**URL:** {url}

## Description

{description}

---
*Auto-generated by AI Content Intelligence Platform*
*Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}*
"""
                
                Path(filename).write_text(content, encoding='utf-8')
                print(f"âœ… Created: {filename}")
            
            print(f"\nðŸŽ‰ Successfully generated {len(articles[:3])} articles!")
        else:
            print(f"âŒ API Error: {data.get('message', 'Unknown error')}")
            print(f"Status: {data.get('status')}")
        EOF
    
    - name: Check generated files
      run: |
        echo "ðŸ“ Generated articles:"
        ls -la generated_articles/ || echo "No articles folder"
        echo ""
        echo "ðŸ“Š Article count:"
        ls -1 generated_articles/*.md 2>/dev/null | wc -l || echo "0"
    
    - name: Commit and push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git add generated_articles/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ¤– Generated articles - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… Articles pushed to GitHub!"
        fi
