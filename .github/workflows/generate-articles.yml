name: Generate Articles Twice Daily

on:
  # Run twice per day - optimized for free tier!
  # Morning: 9 AM UTC, Evening: 9 PM UTC
  # Uses ~20 min/day = 600 min/month (30% of 2,000 free minutes)
  schedule:
    - cron: '0 9 * * *'   # 9 AM UTC (morning update)
    - cron: '0 21 * * *'  # 9 PM UTC (evening update)
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on push to main (for testing)
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/generate-articles.yml'

jobs:
  generate-articles:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to push commits
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache LLM model
      uses: actions/cache@v3
      id: cache-model
      with:
        path: models/
        key: ${{ runner.os }}-tinyllama-1.1b-v1
        restore-keys: |
          ${{ runner.os }}-tinyllama-
    
    - name: Download Mistral-7B Sarcasm model
      if: steps.cache-model.outputs.cache-hit != 'true'
      run: |
        echo "ðŸ“¥ Downloading TinyLlama-1.1B (smaller, faster model)..."
        mkdir -p models
        # Use TinyLlama 1.1B - only 637MB, much faster!
        wget -q --show-progress https://huggingface.co/TheBloke/TinyLlama-1.1B-Chat-v1.0-GGUF/resolve/main/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf -O models/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf
        echo "âœ… Model downloaded successfully!"
        ls -lh models/
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create necessary directories
      run: |
        mkdir -p generated_articles
        mkdir -p memory_store
        mkdir -p logs
    
    - name: Generate satirical articles
      env:
        NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        LOG_LEVEL: INFO
        MAX_WORKERS: 5
        PYTHONUNBUFFERED: 1
      run: |
        echo "ðŸŽ­ Starting SATIRICAL article generation..."
        python -u -c "from src.orchestrator import Orchestrator; o = Orchestrator(); result = o.run_pipeline(); print(f'\n\nFINAL RESULT: {result}')" 2>&1 | tee article_generation.log
        echo "âœ… Satirical article generation complete!"
        echo ""
        echo "Last 50 lines of output:"
        tail -50 article_generation.log || true
    
    - name: Check for new articles
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain generated_articles/)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ New satirical articles generated!"
          echo "Sample titles:"
          ls -1 generated_articles/*.md | head -5 | xargs -I {} basename {} .md
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No new articles (might be duplicates)"
        fi
    
    - name: Commit and push new articles
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git add generated_articles/
        git add memory_store/ || true
        git commit -m "ðŸŽ­ Auto-generated satirical articles - $(date +'%Y-%m-%d %H:%M:%S UTC')"
        git push
    
    - name: Summary
      run: |
        echo "## ðŸŽ­ Satirical Article Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** âœ… Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Time:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Articles:** $(ls -1 generated_articles/*.md 2>/dev/null | wc -l) total" >> $GITHUB_STEP_SUMMARY
        echo "- **New Articles:** ${{ steps.check_changes.outputs.changes == 'true' && 'Yes' || 'No (duplicates filtered)' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Style:** Wildly exaggerated, sarcastic, rage-filled satire ðŸŽ­" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ Next satirical run in 12 hours!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Free Tier Usage (OPTIMIZED!)" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Actions:** ~20 min/day = 600/2000 min/month (30%) âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **API Calls:** ~50 calls/run Ã— 2 runs = 100/day (at limit) âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **LLM:** Local Mistral-7B Sarcasm model (cached) âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Categories:** Technology + Business (high-value content)" >> $GITHUB_STEP_SUMMARY
        echo "- **Cost:** $0.00 ðŸ’°" >> $GITHUB_STEP_SUMMARY
        echo "- **Sustainability:** â™¾ï¸ Forever!" >> $GITHUB_STEP_SUMMARY
